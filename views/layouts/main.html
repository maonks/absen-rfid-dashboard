<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Absensi RFID</title>

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100" hx-boost="false">

<!-- ================= MOBILE HEADER ================= -->
<header class="md:hidden fixed top-0 left-0 right-0 z-50
               h-14 bg-slate-900 text-white
               flex items-center px-4 shadow">

  <button
    onclick="toggleSidebar()"
    class="text-xl mr-3"
  >
    â˜°
  </button>

  <span class="font-semibold">Absensi RFID</span>
</header>

<!-- ================= LAYOUT WRAPPER ================= -->
<div class="flex min-h-screen pt-14 md:pt-0">

  <!-- ================= SIDEBAR ================= -->
  <aside
    id="sidebar"
    class="fixed md:static inset-y-0 left-0 z-40
           w-56 bg-slate-900 text-white
           transform -translate-x-full md:translate-x-0
           transition-transform duration-300
           flex flex-col"
  >

    <!-- HEADER -->
    <div class="p-4 border-b border-slate-700 flex items-center gap-3">

      <!-- AVATAR / LOGO -->
      <div class="w-10 h-10 rounded-full bg-green-500
                  flex items-center justify-center
                  text-slate-900 font-bold">
        {{ if .AuthUser }}
          {{ printf "%.1s" .AuthUser.Nama }}
        {{ else }}
          ğŸ‘¤
        {{ end }}
      </div>

<!-- USER INFO -->
<div class="flex-1 text-left leading-tight">
  {{ if .AuthUser }}
    <!-- NAMA -->
    <div class="text-sm font-semibold text-white">
      {{ .AuthUser.Nama }}
    </div>

    <div class="flex items-center gap-2 mt-0.5">

      <span class="text-[11px] text-slate-400 font-mono">
        @{{ .AuthUser.Username }}
      </span>

      <span class="px-2 py-0.5 text-[10px] rounded text-white
        {{ if eq .AuthUser.Role "admin" }}bg-red-600{{ end }}
        {{ if eq .AuthUser.Role "operator" }}bg-blue-600{{ end }}
        {{ if eq .AuthUser.Role "viewer" }}bg-slate-500{{ end }}
      ">
        {{ .AuthUser.Role }}
      </span>


    </div>

  {{ else }}
    <div class="text-sm font-semibold text-white">
      Absensi Online
    </div>
  {{ end }}
</div>


    </div>



    <!-- MENU -->
    <nav class="flex-1 mt-4 space-y-1">


      <a href="/" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-700 transition">
        <span class="text-lg">ğŸ </span>
        <span>Home Dashboard</span>
      </a>

      <a href="/monitor" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-700 transition">
        <span class="text-lg">ğŸ“¡</span>
        <span>Monitoring Log</span>
      </a>

      <a href="/absensi" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-700 transition">
        <span class="text-lg">ğŸ“Š</span>
        <span>Detail Absensi</span>
      </a>

      <a href="/siswa" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-700 transition">
        <span class="text-lg">ğŸ‘¨â€ğŸ“</span>
        <span>Data Siswa</span>
      </a>
         <a href="/kartu" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-700 transition">
        <span class="text-lg">ğŸ’³</span>
        <span>Daftar Kartu</span>
      </a>

      {{ if eq .AuthUser.Role "admin" }}
      <a
        href="/admin/users"
        hx-boost="false"
        class="flex items-center gap-3 px-4 py-3
              hover:bg-slate-700 transition"
      >
        <span class="text-lg">ğŸ›¡ï¸</span>
        <span>Administrator</span>
      </a>
      {{ end }}



    </nav>

      <!-- FOOTER / LOGOUT (STICKY BOTTOM) -->
      <div class="mt-auto border-t border-slate-700">

        <button
          onclick="logout()"
          class="w-full flex items-center gap-3
                px-4 py-3
                text-left
                text-red-400
                hover:bg-slate-800 hover:text-red-300
                transition"
        >
          <span class="text-lg">ğŸšª</span>
          <span>Logout</span>
        </button>

        <div class="p-3 text-xs text-center text-slate-400">
          <a
            href="https://github.com/maonks"
            target="_blank"
            rel="noopener"
            class="hover:underline hover:text-gray-300"
          >
            Â© 2026 MaonksCode
          </a>
        </div>

      </div>


  </aside>

  <!-- ================= OVERLAY MOBILE ================= -->
  <div
    id="overlay"
    onclick="toggleSidebar()"
    class="fixed inset-0 bg-black/40 z-30 hidden md:hidden"
  ></div>

  <!-- ================= MAIN CONTENT ================= -->
  <main class="flex-1 p-4 md:p-6">

    <!-- HEADER CONTENT -->
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-2">

      <div>
        <h1 class="text-xl md:text-2xl font-bold">
          ğŸ“¡ Dashboard Absensi RFID
        </h1>
        <p class="text-sm text-gray-500">          
          <a
            href="https://github.com/maonks"
            target="_blank"
            rel="noopener"
            class="hover:underline hover:text-gray-700"
          >
            Â© 2026 MaonksCode
          </a>
        </p>

      </div>

      <div
        id="device-status"
        hx-get="/api/device-status"
        hx-trigger="load"
        class="flex gap-2"
      >
        â³ Memuat status device...
      </div>

    </div>

    <!-- CONTENT -->
    <div class="bg-white rounded-xl shadow p-4 md:p-6 space-y-4">
      {{ embed }}
    </div>

  </main>

</div>

<!-- MODAL -->
<div id="modal"></div>

<!-- ====SCRIPT untuk sidebar ====== -->
<script>
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    sidebar.classList.toggle("-translate-x-full");
    overlay.classList.toggle("hidden");
  }
</script>

<!-- ====SCRIPT untuk websocket tap realtime ====== -->
<script>
  const ws = new WebSocket("ws://192.168.1.100:8000/websocket");

  ws.onmessage = (e) => {
    const absenTable = document.getElementById("absen-table");
    if (absenTable) {
      htmx.trigger(absenTable, "reload");
    }

    let data;
    try {
      data = JSON.parse(e.data); // { uid: "XXXX" }
    } catch {
      return; // jika bukan JSON, abaikan
    }

    if (!data.uid) return;

    // coba cari row siswa
    const row = document.getElementById("row-" + data.uid);

    if (row) {
      // siswa sudah ada â†’ refresh BARIS SAJA
      htmx.trigger(row, "refresh");
    } else {
      // siswa baru â†’ reload wrapper (tambah baris)
      const home = document.getElementById("home-realtime");
      if (home) {
        htmx.trigger(home, "reload");
      }
    }
  };
</script>

<!-- ====SCRIPT untuk close modal otomatis ====== -->
<script>
  function closeModal() {
    const modal = document.getElementById("modal");
    if (modal) modal.innerHTML = "";
  }
</script>

<!-- ====SCRIPT untuk logout ====== -->
<script>
  function logout() {
    fetch("/logout", {
      method: "POST",
      credentials: "include" // â¬…ï¸ WAJIB
    }).then(() => {
      window.location.href = "/login";
    });
  }
</script>


<!-- <script>
  document.body.addEventListener("userUpdated", () => {
    const modal = document.getElementById("modal");
    if (modal) modal.innerHTML = "";
  });
</script> -->


<!-- FLOATING WHATSAPP BUTTON -->
<a
  href="https://wa.me/6281239701480?text=Halo%20maonksCODE,%20saya%20ingin%20bertanya"
  target="_blank"
  rel="noopener"
  class="fixed bottom-4 right-4 z-50
         flex items-center gap-2
         bg-green-500 hover:bg-green-600
         text-white
         px-4 py-3
         rounded-full
         shadow-lg
         transition
         md:px-5 md:py-3"
>
  <!-- ICON -->
  <svg
    xmlns="http://www.w3.org/2000/svg"
    class="w-6 h-6"
    fill="currentColor"
    viewBox="0 0 24 24"
  >
    <path
      d="M12 0C5.372 0 0 5.373 0 12c0 2.123.553 4.11 1.515 5.833L0 24l6.317-1.655A11.95 11.95 0 0 0 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-1.83 0-3.548-.503-5.04-1.38l-.36-.21-3.75.98.998-3.648-.233-.375A9.956 9.956 0 1 1 12 22zm5.438-7.41c-.297-.15-1.758-.867-2.03-.967-.273-.1-.472-.15-.67.15-.197.3-.77.967-.943 1.167-.173.2-.347.225-.643.075-.297-.15-1.255-.463-2.39-1.475-.883-.787-1.48-1.76-1.653-2.06-.173-.3-.018-.462.13-.612.133-.132.297-.347.445-.52.15-.173.2-.3.3-.5.1-.2.05-.375-.025-.525-.075-.15-.67-1.612-.918-2.21-.242-.58-.487-.5-.67-.51l-.57-.01c-.197 0-.52.075-.793.375s-1.04 1.016-1.04 2.48 1.065 2.875 1.213 3.075c.15.2 2.095 3.2 5.075 4.487.71.307 1.265.49 1.697.63.713.225 1.36.193 1.873.117.57-.085 1.758-.72 2.006-1.414.248-.695.248-1.29.173-1.414-.075-.125-.272-.2-.57-.35z"
    />
  </svg>

  <!-- TEXT (HIDDEN DI MOBILE KECIL) -->
  <span class="hidden md:inline text-sm font-medium">
    Chat MAONKS-CODE
  </span>
</a>

</body>
</html>
