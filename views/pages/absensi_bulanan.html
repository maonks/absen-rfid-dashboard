<style>
/* ====== ANIMATION ====== */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

@keyframes pulseRed {
  0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,.6); }
  50%     { box-shadow: 0 0 0 6px rgba(239,68,68,0); }
}

.cell {
  animation: fadeUp .35s ease both;
}

.late {
  animation: fadeUp .35s ease both, pulseRed 2s infinite;
}

/* sticky */
.sticky-name {
  position: sticky;
  left: 0;
  background: #f8fafc;
  z-index: 10;
}
.sticky-header {
  position: sticky;
  top: 0;
  background: #f1f5f9;
  z-index: 20;
}
</style>

<!-- LEGEND + FILTER BAR -->
<div class="flex flex-col md:flex-row
            md:items-center md:justify-between
            gap-3 mb-3">

    <!-- ===== LEGEND (KIRI) ===== -->
    <div class="flex flex-wrap items-center gap-4 text-[11px]">

      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded bg-green-500"></span>
        <span>Tepat Waktu</span>
      </div>

      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded bg-red-500"></span>
        <span>Terlambat</span>
      </div>

      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded bg-slate-300"></span>
        <span>Tidak Hadir</span>
      </div>

      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded bg-blue-300"></span>
        <span>Ijin</span>
      </div>

      <div class="flex items-center gap-1.5">
        <span class="w-3 h-3 rounded bg-yellow-300"></span>
        <span>Sakit</span>
      </div>

      <button
        type="button"
        hx-get="/absensi/bulanan/edit-mode"
        hx-target="#absensi-bulanan"
        hx-swap="outerHTML"
        class="px-3 py-1 rounded bg-slate-700 text-white hover:bg-slate-800"
      >
        ‚úèÔ∏è Edit
      </button>


    </div>

      <!-- ===== FILTER (KANAN) ===== -->
    <form
      hx-get="/absensi/bulanan/table"
      hx-target="#absensi-bulanan"
      hx-swap="outerHTML"
      class="flex items-center gap-2 text-[11px]"
    >

      <!-- BULAN -->
      <select name="bulan" class="border rounded px-2 py-1 bg-white">
        {{ range .Months }}
          <option value="{{ .Value }}"
            {{ if eq .Value $.SelectedMonth }}selected{{ end }}>
            {{ .Label }}
          </option>
        {{ end }}
      </select>

      <!-- TAHUN -->
      <select name="tahun" class="border rounded px-2 py-1 bg-white">
        {{ range .Years }}
          <option value="{{ . }}"
            {{ if eq . $.SelectedYear }}selected{{ end }}>
            {{ . }}
          </option>
        {{ end }}
      </select>

      <button
        type="submit"
        class="px-3 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">
        üîç Tampilkan
      </button>

    </form>

</div>




 <!-- ===== Tabel 30 Hari ===== -->
  <div
    id="absensi-bulanan"
    hx-get="/absensi/bulanan/table"
    hx-trigger="refresh"
    hx-swap="outerHTML">

      <div class="overflow-x-auto border rounded-lg shadow-sm">

        <table class="min-w-full text-[11px] border-collapse">

          <!-- HEADER -->
          <thead class="sticky-header">
            <tr>
              <th class="px-2 py-2 border text-center w-10">No</th>
              <th class="px-3 py-2 border text-left w-48 sticky-name">Nama</th>

              {{ range .Days }}
                <th class="px-2 py-2 border text-center">
                  {{ . }}
                </th>
              {{ end }}
            </tr>
          </thead>

          <!-- BODY -->
          <tbody>
          {{ range $i, $row := .Rows }}
            <tr class="hover:bg-slate-50 transition">

              <!-- NO -->
              <td class="px-2 py-1 text-center border">
                {{ add $i 1 }}
              </td>

              <!-- NAMA -->
              <td class="px-3 py-1 border sticky-name font-semibold">
                {{ $row.Nama }}
              </td>

              <!-- DAY CELLS -->
                {{ range $.Days }}
                  {{ $cell := index $row.Hari . }}

                  <td class="px-1 py-1 border text-center align-middle">

                  {{ if not $.EditMode }}

                    <!-- ================= VIEW MODE ================= -->
                    {{ if not $cell }}
                      <div class="cell bg-slate-200 text-slate-500 rounded py-1">-</div>

                    {{ else if eq $cell.Status "LATE" }}
                      <div class="cell late bg-red-500 text-white rounded py-1">
                        {{ $cell.Masuk }}
                      </div>

                    {{ else if eq $cell.Status "OK" }}
                      <div class="cell bg-green-500 text-white rounded py-1">
                        {{ $cell.Masuk }}
                      </div>

                    {{ else if eq $cell.Status "IJIN" }}
                      <div class="cell bg-blue-500 text-white rounded py-1">
                        IJ
                      </div>

                    {{ else if eq $cell.Status "SAKIT" }}
                      <div class="cell bg-purple-500 text-white rounded py-1">
                        SK
                      </div>
                    {{ end }}

                  {{ else }}

                    <!-- ================= EDIT MODE ================= -->
                    <select
                      name="status"
                      class="
                        cell cell-select
                        w-full
                        border border-slate-300
                        focus:outline-none focus:ring-0
                        hover:border-slate-400
                      "
                      hx-post="/absensi/bulanan/update"
                      hx-trigger="change"
                      hx-vals='{
                        "user_id": "{{ $row.ID }}",
                        "tanggal": "{{ . }}"
                      }'
                    >
                      <option value="">-</option>
                      <option value="OK"    {{ if and $cell (eq $cell.Status "OK") }}selected{{ end }}>Hadir</option>
                      <option value="LATE"  {{ if and $cell (eq $cell.Status "LATE") }}selected{{ end }}>Terlambat</option>
                      <option value="IJIN"  {{ if and $cell (eq $cell.Status "IJIN") }}selected{{ end }}>IJ</option>
                      <option value="SAKIT" {{ if and $cell (eq $cell.Status "SAKIT") }}selected{{ end }}>SK</option>
                    </select>

                  {{ end }}

                  </td>
                {{ end }}


            </tr>
          {{ end }}
          </tbody>

         </table>
      </div>
    </div>
</div>